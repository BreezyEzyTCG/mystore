<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Checkout</title>

<!-- Brand font (same as store) -->
<link href="https://fonts.googleapis.com/css2?family=Poetsen+One&display=swap" rel="stylesheet">

<style>
  /* ===== THEME TOKENS (match your site) ===== */
  :root{
    --icon-color-default:#ddeaef;
    --icon-color-active:#789cac;

    --shell:#85adb8;
    --fg:#FBFAF5;
    --page-bg: var(--shell);
    --accent:#ef4444;

    --chip-bg:#072a54;
    --chip-fg:#fff;

    /* BW summary option (if enabled on cart) */
    --bw-bg:#111;
    --bw-fg:#fff;
    --bw-border:#e5e7eb;
  }

  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--page-bg);
    color:#0f172a;
  }

  .wrap{
    max-width: 1100px; margin: 24px auto; padding: 16px;
  }

  /* header (simple match) */
  .hero{
    display:flex; align-items:center; justify-content:space-between;
    padding: 10px 14px; border-radius: 16px; color: var(--fg);
    background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
    border: 1px solid rgba(255,255,255,.18);
    box-shadow: 0 18px 40px rgba(2,6,23,.25);
    font-family: "Poetsen One", system-ui, sans-serif;
  }
  .hero h1{ margin:0; font-size:1.35rem; letter-spacing:.3px; }

  /* layout */
  .grid{
    display:grid; gap:16px;
    grid-template-columns: 1.2fr .8fr;
  }
  @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

  /* card */
  .card{
    background:#fff; border-radius:14px; padding:14px 16px;
    border:1px solid rgba(0,0,0,.06);
    box-shadow: 0 10px 24px rgba(2,6,23,.10);
  }
  .card h2{ margin: 0 0 10px; font-size:1.05rem; }

  /* fields */
  .fields{ display:grid; gap:12px; }
  .row{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 600px){ .row{ grid-template-columns:1fr; } }

  label{ font-size:.92rem; font-weight:600; display:block; margin-bottom:6px; }
  .req::after{ content:" *"; color:#ef4444; }
  input, select, textarea{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.12);
    font-size:.95rem;
  }

  /* small helper text */
  .hint{ font-size:.85rem; opacity:.8; margin-top:6px; }

  /* make payment CTA (hidden until form valid) */
  .pay-cta{
    display:none;
    margin-top:14px;
    padding:12px 14px; border-radius:12px; font-weight:700;
    border:1px solid transparent; cursor:pointer;
    background: var(--chip-bg); color:#fff;
  }
  .pay-cta[disabled]{ opacity:.5; cursor:not-allowed; }
  .pay-cta.show{ display:block; }

  /* order summary (BW theme like your cart option) */
  .summary{
    border-radius:14px; overflow:hidden;
  }
  .sum-header{
    padding: 14px 16px; background:#000; color:#fff;
  }
  .sum-body{ background:#f9fafb; padding: 12px 16px; }
  .sum-row{ display:flex; justify-content:space-between; padding:8px 0; }
  .sum-total{
    background:#000; color:#fff; padding:12px 16px; font-weight:800; border-top:1px solid rgba(255,255,255,.15);
    display:flex; justify-content:space-between;
  }

  /* disclaimer checkbox block (reuse your style) */
  .option-group { display: grid; gap: 8px; }
  .option-list { gap: 6px; }
  .opt-item {
    display:grid; grid-template-columns: 20px 1fr; gap: 10px; align-items:start;
    padding: 8px 10px; border-radius: 10px; background: rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.06);
  }
  .opt-item input{ margin-top: 2px; }
  .disc-text{ font-size:.9rem; }

  /* QR modal */
  #qrModal[hidden]{ display:none; }
  .qr-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.45);
    z-index:10000; display:flex; align-items:center; justify-content:center; padding:16px;
  }
  .qr-dialog{
    width:min(680px, 96vw); background:#fff; border-radius:14px;
    box-shadow:0 24px 60px rgba(0,0,0,.35); overflow:hidden;
  }
  .qr-head{
    background:#0f3a60; color:#fff; padding:14px 16px; display:flex; justify-content:space-between; align-items:center;
  }
  .qr-head h3{ margin:0; font-size:1.05rem; }
  .qr-body{ padding:16px; display:grid; gap:12px; }
  .qr-body img{ max-width:240px; width:100%; border:1px solid rgba(0,0,0,.1); border-radius:10px; }
  .qr-info{ font-size:.95rem; }
  .qr-flex{ display:flex; gap:16px; align-items:flex-start; }
  @media (max-width:600px){ .qr-flex{ flex-direction:column; align-items:stretch; } }

  .danger{ background: var(--accent); color:#fff; border:1px solid rgba(0,0,0,.04); }
  .outline{ background:#fff; color:#0f172a; border:1px solid rgba(0,0,0,.12); }
  .btn{ padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer; }

  /* proof upload */
  .proof{ display:grid; gap:8px; }
  .proof input[type="file"]{ padding:8px; }
  .proof .hint{ margin:0; }
</style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <h1>Checkout</h1>
      <a href="cart.html" class="btn outline" style="text-decoration:none;">← Back to Cart</a>
    </header>

    <div class="grid">
      <!-- Shipping Details -->
      <section class="card">
        <h2>Shipping Details</h2>
        <div class="fields" id="shipForm">
          <div class="row">
            <div>
              <label class="req">Full Name</label>
              <input id="fName" required autocomplete="name" placeholder="e.g., Jane Doe"/>
            </div>
            <div>
              <label class="req">Email</label>
              <input id="fEmail" type="email" required autocomplete="email" placeholder="john.doe@example.com"/>
            </div>
          </div>

          <div class="row">
            <div>
              <label class="req">Phone (+65)</label>
              <input id="fPhone" type="tel" required inputmode="numeric" placeholder="8-digit number"/>
              <div class="hint">Providing accurate information helps us deliver your order smoothly</div>
            </div>
            <div>
              <label class="req">Postal Code</label>
              <input id="fPostal" required inputmode="numeric" maxlength="6" placeholder="6 digits"/>
            </div>
          </div>

          <div>
            <label class="req">Address Line 1</label>
            <input id="fAddr1" required placeholder="Block/Street, Unit #"/>
          </div>
          <div>
            <label>Address Line 2 (Optional)</label>
            <input id="fAddr2" placeholder="Building, landmark"/>
          </div>
          <div class="row">
            <div>
              <label class="req">City</label>
              <input id="fCity" required value="Singapore"/>
            </div>
            <div>
              <label class="req">Selected Mailing Option</label>
              <select id="fMethod" required>
                <!-- ADJUST: add/remove shipping methods; values used in waybill -->
                <option value="">Select…</option>
                <option value="NinjaVan Standard">NinjaVan Standard</option>
                <option value="Qxpress">Qxpress</option>
                <option value="Registered Mail">Registered Mail</option>
                <option value="Self-collection">Self-collection</option>
              </select>
            </div>
          </div>

          <!-- disclaimers you used on cart -->
          <div class="option-group option-list" style="margin-top:10px;">
            <label class="opt-item">
              <input type="checkbox" id="disc1" required>
              <span class="disc-text">Buyers are responsible for additional shipping costs arising from incorrect mailing selection.</span>
            </label>
            <label class="opt-item">
              <input type="checkbox" id="disc2" required>
              <span class="disc-text">We ship around our work schedules; orders may take time to process.</span>
            </label>
          </div>

          <button id="btnPay" class="pay-cta" disabled>Make Payment</button>
          <div class="hint">Button appears when all required fields are valid.</div>
        </div>
      </section>

      <!-- Order Summary -->
      <aside class="summary">
        <div class="sum-header"><strong>Detailed Order Summary</strong></div>
        <div class="sum-body" id="sumBody">
          <!-- items (simple list) -->
          <div id="sumItems" style="margin-bottom:8px;"></div>

          <div class="sum-row"><span>Subtotal</span><strong id="sumSubtotal">$0.00</strong></div>
          <div class="sum-row"><span>Shipping</span><strong id="sumShipping">$0.00</strong></div>
        </div>
        <div class="sum-total">
          <span>Total</span><span id="sumTotal">$0.00</span>
        </div>
      </aside>
    </div>
  </div>

  <!-- QR Modal -->
  <div id="qrModal" hidden>
    <div class="qr-backdrop" role="dialog" aria-modal="true" aria-labelledby="qrTitle">
      <div class="qr-dialog">
        <div class="qr-head">
          <h3 id="qrTitle">PayNow Payment</h3>
          <button class="btn outline" id="qrClose">Close</button>
        </div>
        <div class="qr-body">
          <div class="qr-flex">
            <img id="qrImage" alt="PayNow QR"/>
            <div class="qr-info">
              <div style="margin-bottom:8px;">
                <div><strong>Pay to:</strong> <span id="qrPayTo">—</span></div>
                <div><strong>Amount:</strong> <span id="qrAmount">$0.00</span></div>
                <div><strong>Order ID:</strong> <span id="qrOrderId">—</span></div>
                <div><strong>Time left:</strong> <span id="qrTimer">15:00</span></div>
              </div>
              <div class="hint">Please include the <strong>Order ID</strong> in your payment reference/remarks.</div>
              <div class="proof" style="margin-top:12px;">
                <label>Upload payment screenshot (optional)</label>
                <!-- ADJUST: this only stores in-memory; see security notes below -->
                <input id="proofFile" type="file" accept="image/*"/>
                <p class="hint">You may also WhatsApp/DM us your proof if you prefer.</p>
              </div>
              <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn outline" id="qrCancel">Cancel</button>
                <button class="btn danger" id="qrPaid">I’ve made the payment</button>
              </div>
            </div>
          </div>
          <p class="hint">If the timer runs out, close this window and tap “Make Payment” again to regenerate an Order ID.</p>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Cart helpers (reuse your keying) ===== */
function itemKey(it){
  return [
    it.name ?? '',
    String(Number(it.price) || 0),
    it.series ?? '',
    it.rarity ?? '',
    it.condition ?? ''
  ].join('||');
}
function getCart(){
  try{ const raw = JSON.parse(localStorage.getItem("cart") || "[]"); return Array.isArray(raw)? raw:[]; }
  catch{ return []; }
}

/* ===== Currency ===== */
function fmt(n){ return (n ?? 0).toLocaleString('en-SG',{style:'currency', currency:'SGD'}); }

/* ===== Load summary ===== */
function renderSummary(){
  const cart = getCart();
  const sumItems = document.getElementById('sumItems');
  const sumSubtotal = document.getElementById('sumSubtotal');
  const sumShipping = document.getElementById('sumShipping');
  const sumTotal = document.getElementById('sumTotal');

  let subtotal = 0;
  sumItems.innerHTML = '';

  cart.forEach(it=>{
    const qty = Number(it.qty)||1;
    const price = Number(it.price)||0;
    subtotal += qty*price;

    const row = document.createElement('div');
    row.style.display='flex';
    row.style.justifyContent='space-between';
    row.style.padding='6px 0';
    row.innerHTML = `<span>${it.name} × ${qty}</span><strong>${fmt(qty*price)}</strong>`;
    sumItems.appendChild(row);
  });

  // ADJUST: set your shipping fee rules here
  let shipping = 0;
  const method = document.getElementById('fMethod')?.value || '';
  if(method === 'Registered Mail') shipping = 3.2;
  if(method === 'Qxpress') shipping = 4.5;
  if(method === 'NinjaVan Standard') shipping = 4.0;
  if(method === 'Self-collection') shipping = 0;

  sumSubtotal.textContent = fmt(subtotal);
  sumShipping.textContent = fmt(shipping);
  sumTotal.textContent = fmt(subtotal + shipping);
}

/* ===== Field validation + “Make Payment” visibility ===== */
function allValid(){
  const reqIds = ['fName','fEmail','fPhone','fPostal','fAddr1','fCity','fMethod','disc1','disc2'];
  for(const id of reqIds){
    const el = document.getElementById(id);
    if(!el) return false;
    if(el.type === 'checkbox'){ if(!el.checked) return false; }
    else if(!el.value?.trim()) return false;
  }
  // basic SG checks
  const phone = document.getElementById('fPhone').value.replace(/\D/g,'');
  const postal = document.getElementById('fPostal').value.replace(/\D/g,'');
  if(phone.length !== 8) return false;
  if(postal.length !== 6) return false;

  // cart must have items
  if(getCart().length === 0) return false;

  return true;
}
function syncPayCta(){
  const btn = document.getElementById('btnPay');
  if(allValid()){ btn.classList.add('show'); btn.disabled = false; }
  else{ btn.disabled = true; btn.classList.add('show'); } // keep visible but disabled once revealed
}

/* ===== QR Modal logic ===== */
let countdown = null;
let endTime = 0;

function genOrderId(){
  // ADJUST: short Order ID seed; include timestamp + 4 random chars
  const t = Date.now().toString(36).toUpperCase().slice(-6);
  const r = Math.random().toString(36).toUpperCase().slice(2,6);
  return `BE-${t}${r}`;
}

function openQr(){
  // collect snapshot
  const cart = getCart();
  const total = document.getElementById('sumTotal').textContent;
  const orderId = genOrderId();

  // ADJUST: your PayNow label (UEN or mobile name) shows here
  const payToLabel = "BreezyEzyTCG (UEN XXXXXXXXA)"; // <-- ADJUST

  // ADJUST: your PayNow QR image path.
  // If you generate static QR WITHOUT amount, use a static image in /assets/paynow.png.
  // If you have per-amount QR, you could export QR images per tier and swap here.
  const qrSrc = "assets/paynow-static.png"; // <-- ADJUST

  document.getElementById('qrPayTo').textContent = payToLabel;
  document.getElementById('qrAmount').textContent = total;
  document.getElementById('qrOrderId').textContent = orderId;
  document.getElementById('qrImage').src = qrSrc;

  // Store a lightweight pending order in sessionStorage (no PII)
  sessionStorage.setItem('pendingOrder', JSON.stringify({
    id: orderId,
    total,
    // DO NOT store full address here; keep PII out of client storage if possible
    // We’ll carry PII only to the Thank You page via URL-safe tokenless approach: not at all.
  }));

  // start 15:00 countdown
  endTime = Date.now() + 15*60*1000;
  tick();
  countdown = setInterval(tick, 1000);

  document.getElementById('qrModal').hidden = false;
}
function closeQr(){
  document.getElementById('qrModal').hidden = true;
  clearInterval(countdown);
}
function tick(){
  const remain = Math.max(0, Math.floor((endTime - Date.now())/1000));
  const m = String(Math.floor(remain/60)).padStart(2,'0');
  const s = String(remain%60).padStart(2,'0');
  document.getElementById('qrTimer').textContent = `${m}:${s}`;
  if(remain <= 0){ clearInterval(countdown); }
}

/* ===== Event wiring ===== */
function init(){
  renderSummary();
  syncPayCta();

  // respond to any field changes
  document.querySelectorAll('#shipForm input, #shipForm select')
    .forEach(el=>{
      el.addEventListener('input', ()=>{ renderSummary(); syncPayCta(); });
      el.addEventListener('change', ()=>{ renderSummary(); syncPayCta(); });
    });

  document.getElementById('btnPay').addEventListener('click', openQr);
  document.getElementById('qrClose').addEventListener('click', closeQr);
  document.getElementById('qrCancel').addEventListener('click', closeQr);

  document.getElementById('qrPaid').addEventListener('click', ()=>{
    // (Optional) read file just to confirm presence; we won't upload on GitHub Pages
    const file = document.getElementById('proofFile').files?.[0] || null;
    // You could set a flag like "proofAttached: !!file" in pendingOrder if you need
    // Redirect to thank-you
    window.location.href = "thank-you.html";
  });

  // re-calc shipping when method changes
  document.getElementById('fMethod').addEventListener('change', renderSummary);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
