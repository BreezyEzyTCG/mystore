<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secure Payment Proof Upload (Demo)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .card { max-width: 520px; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; }
    .row { margin: 10px 0; }
    .hint { color: #6b7280; font-size: 0.9rem; }
    .btn { padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; }
    .btn-primary { background: black; color: white; }
    progress { width: 100%; height: 10px; }
    .ok { color: #065f46; }
    .err { color: #991b1b; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Upload payment proof</h2>
    <p class="hint">Your file goes privately to the owner. Others can’t view your upload.</p>

    <form id="uform" action="https://script.google.com/macros/s/AKfycbxriS7NptwgUanj7DIRS0SO6_CvbWAr6RgFKt3LetnGcT1RoRIGnkZGvJsDrcR_TwKR/exec" method="POST">
      <!-- Visible inputs -->
      <div class="row">
        <label>Screenshot (PNG/JPG)
          <input id="file" type="file" accept="image/*" required />
        </label>
      </div>

      <div class="row">
        <label>Note (optional)
          <input name="note" type="text" placeholder="Order #1234" />
        </label>
      </div>

      <!-- Hidden fields actually posted -->
      <input type="hidden" name="file_b64" id="file_b64" />
      <input type="hidden" name="filename" id="filename" />
      <input type="hidden" name="mimetype" id="mimetype" />

      <div class="row">
        <progress id="prog" max="100" value="0" class="hidden"></progress>
        <div id="status" class="hint"></div>
      </div>

      <div class="row">
        <button class="btn btn-primary" id="submitBtn" type="submit" disabled>Upload</button>
      </div>
    </form>
  </div>

  <script>
    const fileInput = document.getElementById('file');
    const b64Field  = document.getElementById('file_b64');
    const nameField = document.getElementById('filename');
    const mimeField = document.getElementById('mimetype');
    const prog      = document.getElementById('prog');
    const statusEl  = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');
    const form      = document.getElementById('uform');

    let fileReady = false;

    fileInput.addEventListener('change', () => {
      const f = fileInput.files[0];
      if (!f) return;

      // Basic guardrails (adjust as you like)
      const okTypes = ['image/png', 'image/jpeg', 'image/webp', 'image/heic', 'image/heif'];
      if (!okTypes.includes(f.type)) {
        statusEl.textContent = 'Please choose a PNG or JPG (or common image).';
        submitBtn.disabled = true;
        return;
      }
      if (f.size > 15 * 1024 * 1024) { // 15 MB
        statusEl.textContent = 'File too large (limit 15 MB for this demo).';
        submitBtn.disabled = true;
        return;
      }

      statusEl.textContent = 'Preparing your file…';
      prog.classList.remove('hidden');
      prog.value = 5;

      const reader = new FileReader();
      reader.onprogress = (e) => {
        if (e.lengthComputable) {
          prog.value = Math.min(95, Math.round((e.loaded / e.total) * 95));
        }
      };
      reader.onload = () => {
        // reader.result is a data URL: "data:image/png;base64,AAAA..."
        const comma = reader.result.indexOf(',');
        const b64 = reader.result.slice(comma + 1);
        b64Field.value = b64;
        nameField.value = f.name;
        mimeField.value = f.type || 'application/octet-stream';
        fileReady = true;
        submitBtn.disabled = false;
        prog.value = 100;
        statusEl.textContent = 'Ready to upload.';
      };
      reader.onerror = () => {
        statusEl.textContent = 'Could not read the file.';
        submitBtn.disabled = true;
      };
      reader.readAsDataURL(f);
    });

    form.addEventListener('submit', (e) => {
      if (!fileReady || !b64Field.value) {
        e.preventDefault();
        statusEl.textContent = 'Choose a file first.';
        return;
      }
      statusEl.textContent = 'Uploading…';
      // Let the standard HTML POST submit to the Apps Script URL (no CORS issues).
    });
  </script>
</body>
</html>
