<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pok√©mon Card Store</title>
  <style>
    :root{
      --icon-color-default:#ddeaef;
      --icon-color-active:#789cac;

      --shell:#58747c;           /* header rim + blue area */
      --fg:#ffffff;
      --chip-bg:#072a54;         /* cart button background */
      --chip-fg:#fff;
      --accent:#ef4444;          /* cart badge fill */
    }

    body{ font-family:Arial,sans-serif; margin:0; background:#f0f4f8; }

    /* ================== HERO HEADER ================== */
    .site-shell{
      position:sticky; top:0; z-index:20;
      background:var(--shell);
      box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    .shell-pad{ padding:10px 12px 0; }

    .hero{
      position:relative;
      height:clamp(160px, 28vw, 260px);
      border-radius:14px; overflow:hidden;
      background-image:url("assets/images/Breezy%20Banner.png");
      background-size:cover;
      background-position:center 30%;
    }
    .hero::before{
      content:""; position:absolute; inset:0;
      background:linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.25));
      pointer-events:none;
    }

    .topbar{
      position:absolute; top:10px; right:12px;
      display:flex; align-items:center; gap:.5rem; z-index:5;
    }
    .cart-link{
      position:relative; display:inline-flex; align-items:center; gap:.5rem;
      color:var(--chip-fg); text-decoration:none; background:var(--chip-bg);
      padding:.55rem .85rem; border-radius:.7rem; font-weight:700; white-space:nowrap;
    }
    .cart-link img{ width:20px; height:20px; display:block;
      filter: invert(98%) sepia(1%) saturate(76%) hue-rotate(180deg) brightness(104%) contrast(95%); }
    .cart-count{
      position:absolute; top:-6px; right:-6px; min-width:10px; height:20px; padding:0 6px;
      background:#1bb9df; color:#f5f5f5; border:2px solid #ffffff; border-radius:999px;
      font-size:.75rem; line-height:16px; display:flex; align-items:center; justify-content:center;
      font-weight:800; pointer-events:none; box-shadow:0 2px 6px rgba(0,0,0,.18);
    }
    @media (min-width:768px){
      .cart-link img{ width:22px; height:22px; }
      .cart-count{ top:-7px; right:-7px; min-width:22px; height:22px; line-height:18px; }
    }

    .brand-center{
      position:absolute; inset:0; z-index:2; display:flex; align-items:center; justify-content:center;
      text-align:center; color:var(--fg); padding:0 12px; pointer-events:none;
    }
    .brand-title{
      margin:0; line-height:1.1; font-weight:800; font-size:clamp(1.6rem, 5.2vw, 2.6rem);
      text-shadow:0 2px 10px rgba(0,0,0,.35);
    }
    .brand-subtitle{
      margin:.35rem 0 0 0; opacity:.95; font-size:clamp(.95rem, 3vw, 1.2rem);
      text-shadow:0 1px 6px rgba(0,0,0,.35);
    }

    /* ========= Filter bar (inside blue header) ========= */
    .filter-bar{ background:var(--shell); padding:12px 12px 14px; }
    .filter-grid{
      max-width:1200px; margin:0 auto;
      display:grid; gap:0.5rem;
      grid-template-columns: repeat(4, minmax(0, 1fr)); /* desktop */
      align-items:center;
    }
    .filter-grid select, .filter-grid input[type="text"]{
      width:100%; padding:0.55rem 0.65rem; border-radius:8px;
      border:1px solid rgba(255,255,255,.3); background:#ffffff; color:#111;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    /* Search alignment: span first two columns on desktop, full row on mobile/tablet */
    #search{
      grid-column:1 / span 2;    /* desktop: centered above first two selects */
      justify-self:stretch;
    }
    @media (max-width:1023.98px){
      .filter-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      #search{ grid-column:1 / -1; } /* full width on tablet */
    }
    @media (max-width:767.98px){
      .filter-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      #search{ grid-column:1 / -1; } /* full width on mobile */
    }

    /* ================== Controls (grid toggle only now) ================== */
    .controls{
      display:flex; justify-content:flex-end; align-items:center; gap:0.75rem;
      margin:0.75rem auto 0; max-width:1200px; padding:0 1rem;
    }
    .grid-toggle{ display:flex; justify-content:flex-end; gap:0.5rem; margin:0; }
    .layout-button{
      background:transparent; border:none; padding:0.5rem; border-radius:6px;
      cursor:pointer; display:flex; align-items:center; justify-content:center;
      transition:transform .15s ease;
    }
    .layout-button:active{ transform:scale(0.96); }
    .layout-button svg{ width:24px; height:24px; fill:var(--icon-color-default); transition:fill .2s; }
    .layout-button.single svg{ width:30px; height:30px; }
    .layout-button.active svg{ fill:var(--icon-color-active); }

    /* ================== Cards ================== */
    .card-container{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:1.5rem; max-width:1200px; margin:1.25rem auto 2rem; padding:0 1rem; transition:all .3s ease;
    }
    .card-container.grid-1{ grid-template-columns:repeat(1,1fr); }
    .card-container.grid-2{ grid-template-columns:repeat(2,1fr); }
    .card-container.grid-3{ grid-template-columns:repeat(3,1fr); }

    .card{
      position:relative; background:#fff; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,.08);
      overflow:hidden; display:flex; flex-direction:column; padding:1rem; text-align:center;
    }
    .card img{ width:100%; aspect-ratio:4/3; object-fit:contain; margin-bottom:0.5rem; border-radius:5px; }

    .title-block{ min-height:calc(1 * 1.2em + 3 * 1.3em); }
    .card-title{
      font-size:1.25rem; margin:0.25rem 0; line-height:1.2; display:-webkit-box;
      -webkit-box-orient:vertical; -webkit-line-clamp:1; overflow:hidden; min-height:1.2em;
    }
    .series-name{
      font-size:0.7rem; color:#555; margin:0.2rem 0 0.6rem; font-style:italic;
      display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:3; overflow:hidden;
      line-height:1.3; min-height:calc(3 * 1.3em);
    }

    .card-info{ min-height: calc(4 * (1.3em + 0.5rem)); display:flex; flex-direction:column; }
    .price,.rarity,.condition,.stock{ font-size:1rem; line-height:1.3; margin:0.25rem 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .badge{ position:absolute; top:0.5rem; left:0.5rem; padding:5px 10px; font-size:0.75rem; font-weight:bold; border-radius:4px; z-index:2; text-transform:uppercase; box-shadow:0 2px 5px rgba(0,0,0,.2); line-height:1; }
    .badge.sale{ background:#e02424; color:#fff; }
    .badge.popular{ background:#ffcc00; color:#000; }
    .badge.new{ background:#2fbf71; color:#f8f9fb; }

    .product-actions{ margin-top:auto; }
    button{ margin-top:0.5rem; padding:0.5rem 1rem; background:#2b6cb0; color:#fff; border:none; border-radius:5px; cursor:pointer; transition:opacity .2s, transform .15s; }

    .container-panel{ max-width:1200px; margin:0 auto 2rem; padding:0 0 1rem; background:#fff; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.05); }

    /* Mobile: keep no single on desktop, no triple on mobile */
    @media (max-width:767.98px){ .layout-button.triple{ display:none; } }
    @media (min-width:768px){ .layout-button.single{ display:none; } }

    .product-actions button[disabled], button[disabled]{
      background:#cbd5e1 !important; color:#6b7280 !important; cursor:not-allowed !important;
      pointer-events:none; box-shadow:none !important; transform:none !important; opacity:1 !important;
    }

    /* Toast */
    #toast{ display:none; position:fixed; bottom:10px; right:10px; background:#e31996; color:#f5f5f5; padding:10px 15px; border-radius:5px; z-index:1000; opacity:0; transition:opacity .5s ease; }
    #toast.show{ display:block; opacity:1; }
  </style>
</head>
<body>

  <!-- ===== Overlay Banner Header ===== -->
  <div class="site-shell">
    <div class="shell-pad">
      <div class="hero">
        <div class="topbar">
          <a class="cart-link" href="cart.html" aria-label="Cart">
            <img src="assets/images/cart-3-svgrepo-com.svg" alt="Cart" />
            <span class="cart-count" id="cartCount">0</span>
          </a>
        </div>
        <div class="brand-center">
          <div>
            <h1 class="brand-title">BreezyEzyTCG</h1>
            <p class="brand-subtitle">COLLECTIBLES STORE</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter bar inside blue header -->
    <div class="filter-bar">
      <div class="filter-grid">
        <!-- Search centered above first two selects on desktop; full width on mobile -->
        <input type="text" id="search" placeholder="Search for a card..." oninput="applyFilters()" />

        <!-- Row 2 -->
        <select id="category-filter" onchange="onCategoryChange()">
          <option value="all">All Categories</option>
        </select>
        <select id="subcategory-filter" onchange="applyFilters()">
          <option value="all">All Subcategories</option>
        </select>
        <select id="rarity-filter" onchange="applyFilters()">
          <option value="all">All Rarity</option>
        </select>
        <select id="condition-filter" onchange="applyFilters()">
          <option value="all">All Conditions</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Controls: just the view toggle now -->
  <div class="container-panel">
    <div class="controls">
      <div class="grid-toggle">
        <button class="layout-button single" type="button" onclick="setGridView(1)" aria-label="Single column">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="3" ry="3"/></svg>
        </button>
        <button class="layout-button double active" type="button" onclick="setGridView(2)" aria-label="Two columns">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path fill-rule="evenodd" d="M5 2a3 3 0 0 0-3 3v3a3 3 0 0 0 3 3h3a3 3 0 0 0 3-3V5a3 3 0 0 0-3-3H5Zm11 11a3 3 0 0 0-3 3v3a3 3 0 0 0 3 3h3a3 3 0 0 0 3-3v-3a3 3 0 0 0-3-3h-3Zm0-2a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3h3a3 3 0 0 1 3 3v3a3 3 0 0 1-3 3h-3ZM5 22a3 3 0 0 1-3-3v-3a3 3 0 0 1 3-3h3a3 3 0 0 1 3 3v3a3 3 0 0 1-3 3H5Z" clip-rule="evenodd"/>
          </svg>
        </button>
        <button class="layout-button triple" type="button" onclick="setGridView(3)" aria-label="Three columns">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path fill-rule="evenodd" d="M4 5a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H4Zm7 0a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2Zm7 6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2ZM4 12a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2H4Zm7 0a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2h-2Zm7 6a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2Z" clip-rule="evenodd"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="card-container grid-2"></div>
  </div>

  <div id="toast"></div>

  <script>
    let allProducts = [];

    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRDJRZBMe5zGA4VmLoAQnCV1X21yZN7nmGy9U0UChcldGIV4r7FX3-9XgEbvrsEOL6nJn8VhY58Ic50/pub?output=csv";

    function isMobile(){ return window.matchMedia("(max-width: 767.98px)").matches; }

    let toastHideTimer = null;
    function showToast(msg, duration = 3000) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.style.display = "block";
      toast.classList.remove("show");
      void toast.offsetWidth;
      toast.classList.add("show");
      if (toastHideTimer) clearTimeout(toastHideTimer);
      toastHideTimer = setTimeout(() => {
        toast.classList.remove("show");
        const done = (e) => {
          if (e.propertyName === "opacity" && !toast.classList.contains("show")) {
            toast.style.display = "none";
            toast.removeEventListener("transitionend", done);
          }
        };
        toast.addEventListener("transitionend", done);
      }, duration);
    }

    const safeNumber = (v,f=0)=>Number.isFinite(+v)?+v:f;

    /* Cart helpers */
    const getCart=()=>{ try{return JSON.parse(localStorage.getItem("cart")||"[]");}catch{return[];} };
    const getCartCount=()=>getCart().reduce((s,i)=>s+safeNumber(i.quantity,0),0);
    function updateCartCount(){ const el=document.getElementById("cartCount"); if(el) el.textContent=String(getCartCount()); }

    function addToCart(name, price, image_url){
      const cart = getCart();
      const found = cart.find(i => i.name === name);
      if(found) found.quantity += 1; else cart.push({ name, price, quantity:1, image:image_url });
      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartCount(); showToast(`${name} added to cart!`);
    }

    async function fetchInventoryFromSheet(){
      try{
        const res = await fetch(SHEET_CSV);
        const csv = await res.text();
        const rows = csv.trim().split("\n").map(r => r.split(","));
        const headers = rows.shift().map(h => h.trim().toLowerCase());

        allProducts = rows.map(row => {
          const obj = {};
          row.forEach((cell, i) => {
            const key = headers[i];
            if (key === "price" || key === "stock") obj[key] = safeNumber(cell);
            else obj[key] = (cell || "").trim();
          });
          obj.category    = (row[4] || obj.category    || "").trim(); // Column E
          obj.subcategory = (row[5] || obj.subcategory || "").trim(); // Column F
          obj.rarity      = (row[6] || obj.rarity      || "").trim(); // Column G
          obj.condition   = (row[7] || obj.condition   || "").trim(); // Column H
          return obj;
        });

        populateAllDropdowns();
        renderStore(allProducts);
        enforceResponsiveGrid();
      }catch(e){
        console.error(e);
        document.querySelector(".card-container").innerHTML = "<p>Error loading store inventory.</p>";
      }
    }

    function getBadgeInfo(raw){
      if(!raw) return null;
      const t = String(raw).trim().toLowerCase();
      if(["sale","sales"].includes(t)) return { cls:"sale", label:"SALE" };
      if(t === "new") return { cls:"new", label:"NEW" };
      if(["popular","hot"].includes(t)) return { cls:"popular", label:"POPULAR" };
      return null;
    }

    function renderStore(list){
      const container = document.querySelector(".card-container");
      container.innerHTML = "";

      list.forEach(p => {
        const stock = safeNumber(p.stock, 0);
        const price = safeNumber(p.price, 0);
        const out = stock <= 0;

        const badge = getBadgeInfo(p.badge);
        const safeName = String(p.name || "").replace(/'/g, "\\'");
        const safeImg  = String(p.image_url || "").replace(/'/g, "\\'");

        const btnAttrs = out
          ? `disabled aria-disabled="true" tabindex="-1"`
          : `onclick="addToCart('${safeName}', ${price}, '${safeImg}')"`;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          ${badge ? `<div class="badge ${badge.cls}">${badge.label}</div>` : ``}
          <img src="${p.image_url || ""}" alt="${p.name || "Card"}" />
          <div class="title-block">
            <h3 class="card-title">${p.name || ""}</h3>
            <p class="series-name">${p["series name"] || ""}</p>
          </div>
          <div class="card-info">
            <p class="price">$${price.toFixed(2)}</p>
            <p class="rarity"><strong>Rarity:</strong> ${p.rarity || ""}</p>
            <p class="condition"><strong>Condition:</strong> ${p.condition || ""}</p>
            <p class="stock"><strong>Stock:</strong> ${stock}</p>
          </div>
          <div class="product-actions">
            <button ${btnAttrs}>${out ? "Out of Stock" : "Add to Cart"}</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    const byUniqueSorted = (arr) => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b));

    function populateAllDropdowns(){
      const catSel = document.getElementById("category-filter");
      catSel.querySelectorAll("option:not([value='all'])").forEach(o => o.remove());
      byUniqueSorted(allProducts.map(p => p.category)).forEach(c => {
        const opt = document.createElement("option"); opt.value=c; opt.textContent=c; catSel.appendChild(opt);
      });

      const rarSel = document.getElementById("rarity-filter");
      rarSel.querySelectorAll("option:not([value='all'])").forEach(o => o.remove());
      byUniqueSorted(allProducts.map(p => p.rarity)).forEach(r => {
        const opt = document.createElement("option"); opt.value=r; opt.textContent=r; rarSel.appendChild(opt);
      });

      const conSel = document.getElementById("condition-filter");
      conSel.querySelectorAll("option:not([value='all'])").forEach(o => o.remove());
      byUniqueSorted(allProducts.map(p => p.condition)).forEach(c => {
        const opt = document.createElement("option"); opt.value=c; opt.textContent=c; conSel.appendChild(opt);
      });

      updateSubcategoryOptions();
    }

    function updateSubcategoryOptions(){
      const cat = document.getElementById("category-filter").value;
      const subSel = document.getElementById("subcategory-filter");
      const pool = (cat === "all") ? allProducts : allProducts.filter(p => p.category === cat);
      const subs = byUniqueSorted(pool.map(p => p.subcategory));

      const current = subSel.value;
      subSel.querySelectorAll("option:not([value='all'])").forEach(o => o.remove());
      subs.forEach(s => { const opt=document.createElement("option"); opt.value=s; opt.textContent=s; subSel.appendChild(opt); });
      if (current !== "all" && subs.includes(current)) subSel.value = current; else subSel.value = "all";
    }

    function onCategoryChange(){ updateSubcategoryOptions(); applyFilters(); }

    function applyFilters(){
      const kw   = document.getElementById("search").value.toLowerCase();
      const cat  = document.getElementById("category-filter").value;
      const sub  = document.getElementById("subcategory-filter").value;
      const rar  = document.getElementById("rarity-filter").value;
      const cond = document.getElementById("condition-filter").value;

      const filtered = allProducts.filter(p =>
        (p.name || "").toLowerCase().includes(kw) &&
        (cat === "all" || p.category === cat) &&
        (sub === "all" || p.subcategory === sub) &&
        (rar === "all" || p.rarity === rar) &&
        (cond === "all" || p.condition === cond)
      );
      renderStore(filtered);
    }

    function activateButton(type){
      document.querySelectorAll(".layout-button").forEach(b => b.classList.remove("active"));
      if(type === 1) document.querySelector(".layout-button.single")?.classList.add("active");
      if(type === 2) document.querySelector(".layout-button.double")?.classList.add("active");
      if(type === 3) document.querySelector(".layout-button.triple")?.classList.add("active");
    }

    function setGridView(type){
      if(isMobile() && type === 3) return;
      if(!isMobile() && type === 1) return;
      const cont = document.querySelector(".card-container");
      cont.classList.remove("grid-1","grid-2","grid-3");
      cont.classList.add(`grid-${type}`);
      activateButton(type);
      applyFilters();
    }

    function enforceResponsiveGrid(){
      const cont = document.querySelector(".card-container");
      if(isMobile() && cont.classList.contains("grid-3")) setGridView(2);
      else if(!isMobile() && cont.classList.contains("grid-1")) setGridView(2);
    }

    window.addEventListener("storage", (e) => { if (e.key === "cart") updateCartCount(); });
    window.addEventListener("resize", enforceResponsiveGrid);
    window.addEventListener("orientationchange", enforceResponsiveGrid);

    updateCartCount();
    fetchInventoryFromSheet();
  </script>
</body>
</html>
