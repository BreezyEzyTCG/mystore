<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PokÃ©mon Card Store</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background-color: #f0f4f8; }
    header { background-color: #1a202c; color: white; padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 10; }
    .cart-link { position: absolute; right: 1rem; top: 1rem; color: white; text-decoration: none; background: #2d3748; padding: 0.5rem 1rem; border-radius: 5px; }

    .container-panel { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; background-color: white; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
    .controls { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 0.5rem; margin: 1.5rem auto 0; flex-direction: row; max-width: 100%; }
    .controls input, .controls select { padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; }

    .grid-toggle { display: flex; justify-content: center; gap: 0.5rem; margin: 1rem auto; }
    .layout-button { background: transparent; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer; transition: background 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .layout-button svg { width: 24px; height: 24px; fill: #264b67; }
    .layout-button.active { background-color: #cce4f6; }

    .card-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; max-width: 1200px; margin: 2rem auto; padding: 0 1rem; transition: all 0.3s ease; }
    .card-container.grid-1 { grid-template-columns: repeat(1, 1fr); }
    .card-container.grid-2 { grid-template-columns: repeat(2, 1fr); }
    .card-container.grid-3 { grid-template-columns: repeat(3, 1fr); }

    .card { position: relative; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); overflow: hidden; display: flex; flex-direction: column; padding: 1rem; text-align: center; }
    .card img { width: 100%; aspect-ratio: 4/3; object-fit: contain; margin-bottom: 0.5rem; border-radius: 5px; }
    .card h3 { font-size: 1.25rem; margin: 0.25rem 0; }
    .series-name { font-size: 0.7rem; color: #555; margin: 0.2rem 0 0.6rem; font-style: italic; white-space: normal; word-break: break-word; }
    .condition, .price, .stock { font-size: 1rem; margin: 0.25rem 0; }

    .badge { position: absolute; top: 0.5rem; left: 0.5rem; padding: 5px 10px; font-size: 0.75rem; font-weight: bold; color: grey; border-radius: 4px; z-index: 2; text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .badge.sale { background-color: #c21807; }
    .badge.popular { background-color: #ffcc00; color: black; }
    .badge.new { background-color: #4cbb17; }

    .product-actions { margin-top: auto; }
    button { margin-top: 0.5rem; padding: 0.5rem 1rem; background-color: #2b6cb0; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #2c5282; }
    button:disabled { background-color: #aaa; cursor: not-allowed; opacity: 0.7; }

    /* Toggle buttons visibility rules */
    /* Desktop: 2 & 3 only */
    .layout-button.single { display: none; }
    .layout-button.double { display: flex; }
    .layout-button.triple { display: flex; }
    /* Mobile: Single & 2 only */
    @media (max-width: 768px) {
      .layout-button.single { display: flex; }
      .layout-button.double { display: flex; }
      .layout-button.triple { display: none; }
    }

    .status { text-align:center; color:#264b67; padding: 1rem; }
    .error { color:#c21807; }
  </style>
</head>
<body>
  <header>
    <h1>BreezyEzyTCG Collectibles Store</h1>
    <a class="cart-link" href="cart.html">ðŸ›’ Cart</a>
  </header>

  <div class="container-panel">
    <div class="controls">
      <input type="text" id="search" placeholder="Search for a card..." oninput="applyFilters()" />
      <select id="category-filter" onchange="applyFilters()">
        <option value="all">All Categories</option>
      </select>
      <div class="grid-toggle">
        <!-- Single (mobile only) -->
        <button class="layout-button single" onclick="setGridView(1)" aria-label="1-Grid View">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/></svg>
        </button>
        <!-- Double -->
        <button class="layout-button double active" onclick="setGridView(2)" aria-label="2-Grid View">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M5 2a3 3 0 0 0-3 3v3a3 3 0 0 0 3 3h3a3 3 0 0 0 3-3V5a3 3 0 0 0-3-3H5Zm11 11a3 3 0 0 0-3 3v3a3 3 0 0 0 3 3h3a3 3 0 0 0 3-3v-3a3 3 0 0 0-3-3h-3Z"/></svg>
        </button>
        <!-- Triple (desktop only) -->
        <button class="layout-button triple" onclick="setGridView(3)" aria-label="3-Grid View">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M4 4h5v5H4V4Zm0 7h5v5H4v-5Zm0 7h5v5H4v-5Zm7-14h9v5h-9V4Zm0 7h9v5h-9v-5Zm0 7h9v5h-9v-5Z"/></svg>
        </button>
      </div>
    </div>

    <div id="status" class="status">Loading inventoryâ€¦</div>
    <div class="card-container grid-2"></div>
  </div>

  <div id="toast" style="display:none; position:fixed; bottom:10px; right:10px; background:#333; color:#fff; padding:10px 15px; border-radius:5px; z-index:1000;"></div>

  <script>
    var MOBILE_MAX = 768;
    var allProducts = [];

    function isMobile() { return window.innerWidth <= MOBILE_MAX; }

    function showToast(message) {
      var toast = document.getElementById("toast");
      toast.innerText = message;
      toast.style.display = "block";
      setTimeout(function(){ toast.style.display = "none"; }, 2000);
    }

    function addToCart(name, price, image_url) {
      var cart = JSON.parse(localStorage.getItem("cart") || "[]");
      var existing = cart.find(function(item){ return item.name === name; });
      if (existing) existing.quantity += 1;
      else cart.push({ name: name, price: price, quantity: 1, image: image_url });
      localStorage.setItem("cart", JSON.stringify(cart));
      showToast(name + " added to cart!");
    }

    // Robust CSV parser (handles quotes and commas)
    function parseCSV(text) {
      var rows = [], row = [], cur = "", inQuotes = false, i, c;
      for (i = 0; i < text.length; i++) {
        c = text[i];
        if (c === '"') {
          if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (c === ',' && !inQuotes) {
          row.push(cur); cur = "";
        } else if ((c === '\n' || c === '\r') && !inQuotes) {
          if (cur !== "" || row.length) { row.push(cur); rows.push(row); row = []; cur = ""; }
          if (c === '\r' && text[i+1] === '\n') i++;
        } else {
          cur += c;
        }
      }
      if (cur !== "" || row.length) { row.push(cur); rows.push(row); }
      return rows;
    }

    function numOrZero(v){ var n = parseFloat(v); return isFinite(n) ? n : 0; }
    function textOrEmpty(v){ return (v == null) ? "" : String(v); }

    function httpGet(url, onOK, onErr){
      if (window.fetch) {
        fetch(url).then(function(r){ return r.text(); }).then(onOK).catch(onErr);
      } else {
        var x = new XMLHttpRequest();
        x.open('GET', url, true);
        x.onreadystatechange = function(){
          if (x.readyState === 4) {
            if (x.status >= 200 && x.status < 300) onOK(x.responseText);
            else onErr(new Error('XHR ' + x.status));
          }
        };
        x.send();
      }
    }

    function fetchInventoryFromSheet() {
      var sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRDJRZBMe5zGA4VmLoAQnCV1X21yZN7nmGy9U0UChcldGIV4r7FX3-9XgEbvrsEOL6nJn8VhY58Ic50/pub?output=csv";
      var status = document.getElementById("status");

      httpGet(sheetURL, function(data){
        try {
          var rows = parseCSV(data);
          if (!rows.length) throw new Error("Empty CSV");
          var headers = rows.shift().map(function(h){ return h.trim().toLowerCase(); });

          allProducts = rows.map(function(row){
            var obj = {}, i, key, cell;
            for (i = 0; i < headers.length; i++) {
              key = headers[i];
              cell = (row[i] || "").trim();
              if (key === "price" || key === "stock") obj[key] = numOrZero(cell);
              else obj[key] = cell;
            }
            return obj;
          });

          populateCategoryDropdown();
          renderStore(allProducts);
          enforceResponsiveView();
          status.style.display = "none";
        } catch (e) {
          console.error(e);
          status.className = "status error";
          status.textContent = "Error parsing inventory.";
        }
      }, function(err){
        console.error(err);
        status.className = "status error";
        status.textContent = "Error loading store inventory.";
      });
    }

    function renderStore(products) {
      var container = document.querySelector(".card-container");
      container.innerHTML = "";

      products.forEach(function(product){
        var disabled = product.stock <= 0 ? "disabled" : "";
        var buttonText = product.stock <= 0 ? "Out of Stock" : "Add to Cart";
        var badgeText = textOrEmpty(product.badge);
        var badgeClass = badgeText ? badgeText.toLowerCase() : "";
        var imgSrc = product.image_url || product.image || product["image url"] || "";

        var html = ''
          + '<div class="card">'
          +   '<div class="badge ' + badgeClass + '">' + badgeText + '</div>'
          +   '<img src="' + imgSrc + '" alt="' + textOrEmpty(product.name) + '" />'
          +   '<h3>' + textOrEmpty(product.name) + '</h3>'
          +   '<p class="series-name">' + textOrEmpty(product["series name"]) + '</p>'
          +   '<p class="condition"><strong>Condition:</strong> ' + (textOrEmpty(product.condition) || "N/A") + '</p>'
          +   '<p class="price">$' + numOrZero(product.price).toFixed(2) + '</p>'
          +   '<p class="stock"><strong>Stock:</strong> ' + numOrZero(product.stock) + '</p>'
          +   '<div class="product-actions">'
          +     '<button ' + disabled + ' onclick="addToCart(\'' +
                    textOrEmpty(product.name).replace(/'/g,"\\'") + '\',' +
                    numOrZero(product.price) + ',\'' +
                    imgSrc.replace(/'/g,"\\'") + '\')">' + buttonText + '</button>'
          +   '</div>'
          + '</div>';

        var wrapper = document.createElement("div");
        wrapper.innerHTML = html;
        container.appendChild(wrapper.firstChild);
      });
    }

    function populateCategoryDropdown() {
      var select = document.getElementById("category-filter");
      var seen = {};
      allProducts.forEach(function(p){
        var cat = p.category || "";
        if (cat && !seen[cat]) {
          seen[cat] = true;
          var option = document.createElement("option");
          option.value = cat;
          option.textContent = cat;
          select.appendChild(option);
        }
      });
    }

    function applyFilters() {
      var keyword = document.getElementById("search").value.toLowerCase();
      var selectedCategory = document.getElementById("category-filter").value;
      var filtered = allProducts.filter(function(p){
        var name = (p.name || "").toLowerCase();
        var okName = name.indexOf(keyword) !== -1;
        var okCat = (selectedCategory === "all") || (p.category === selectedCategory);
        return okName && okCat;
      });
      renderStore(filtered);
    }

    function currentGridType() {
      var c = document.querySelector(".card-container");
      if (c.classList.contains("grid-1")) return 1;
      if (c.classList.contains("grid-2")) return 2;
      if (c.classList.contains("grid-3")) return 3;
      return 2;
    }

    function updateActiveButton(type) {
      var btns = document.querySelectorAll(".layout-button");
      for (var i=0;i<btns.length;i++) btns[i].classList.remove("active");
      if (type === 1) { var b1 = document.querySelector(".layout-button.single"); if (b1) b1.classList.add("active"); }
      if (type === 2) { var b2 = document.querySelector(".layout-button.double"); if (b2) b2.classList.add("active"); }
      if (type === 3) { var b3 = document.querySelector(".layout-button.triple"); if (b3) b3.classList.add("active"); }
    }

    function setGridView(type) {
      if (isMobile() && type === 3) type = 2;   // mobile cannot use 3-grid
      if (!isMobile() && type === 1) type = 2;  // desktop cannot use single

      var container = document.querySelector(".card-container");
      container.classList.remove("grid-1","grid-2","grid-3");
      if (type === 1) container.classList.add("grid-1");
      else if (type === 2) container.classList.add("grid-2");
      else if (type === 3) container.classList.add("grid-3");

      updateActiveButton(type);
      applyFilters();
    }

    function enforceResponsiveView() {
      var cur = currentGridType();
      if (isMobile()) {
        if (cur === 3) setGridView(2); else updateActiveButton(cur);
      } else {
        if (cur === 1) setGridView(2); else updateActiveButton(cur);
      }
    }

    window.addEventListener("resize", enforceResponsiveView);
    document.addEventListener("DOMContentLoaded", enforceResponsiveView);

    fetchInventoryFromSheet();
  </script>
</body>
</html>
